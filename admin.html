<!DOCTYPE html>
<html>
<head>
    <title>Site Admin</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <style>
        body { padding: 20px; background-color: #f4f4f4; }
        .editor-container { background: white; padding: 20px; border-radius: 8px; display: none; }
        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="login-section" class="login-container">
        <h3>Admin Login</h3>
        <input type="email" id="email" class="form-control mb-2" placeholder="Email">
        <input type="password" id="password" class="form-control mb-2" placeholder="Password">
        <button id="login-btn" class="btn btn-primary w-100">Login</button>
        <p id="login-error" class="text-danger mt-2"></p>
    </div>

    <div id="dashboard-section" class="container editor-container">
        <div class="d-flex justify-content-between">
            <h2>IGNITE Website Content Editor</h2>
            <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
        </div>
        <hr>

        <label><strong>Select Page to Edit:</strong></label>
        <select id="page-selector" class="form-select mb-4">
    <option value="home">Home Page</option>
    <option value="about">Welcome Page</option>
    <option value="contact">Contact Page</option>
    <option value="notifications">Notifications Popup</option>
    <option value="youngadults">Young Adults Page</option>
    <option value="youth">Youth Page</option>
  <option value="kids">Kids Page</option>
<option value="footer">Footer / Global Content</option>
</select>

        <div id="editor-fields">
            </div>

        <button id="save-btn" class="btn btn-success mt-3">Save Changes</button>
        <p id="status-msg" class="mt-2"></p>
    </div>
<script type="module">
    import { db, auth, doc, getDoc, setDoc, signInWithEmailAndPassword, onAuthStateChanged, signOut } from './firebase-config.js';

    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const pageSelector = document.getElementById('page-selector');
    const editorFields = document.getElementById('editor-fields');

    // --- Authentication ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            loadPageData(pageSelector.value);
        } else {
            loginSection.style.display = 'block';
            dashboardSection.style.display = 'none';
        }
    });

    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            document.getElementById('login-error').innerText = "Invalid Login";
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // --- Editor Configuration ---
    const pageConfig = {
        'home': [
            { id: 'hometitle', label: 'Welcome Title' },
            { id: 'home_news_ticker', label: 'News Ticker Items', type: 'ticker' },
            { id: 'home_features', label: 'Feature Cards (Welcome Home)', type: 'cards' },
            { id: 'home_slider', label: 'Slider Images (What\'s Happening)', type: 'cards' }
        ],
        'about': [
            { id: 'edit1', label: 'Section Description' },
            { id: 'edit2', label: 'Main Description' }
        ],
        'contact': [
            { id: 'contact_title', label: 'Page Title' },
            { id: 'contact_phone', label: 'Phone Number' },
            { id: 'contact_email', label: 'Email Address' }
        ],
        'notifications': [
            { id: 'notification_title', label: 'Header Title' },
            { id: 'notification_items', label: 'Notifications', type: 'ticker' } 
        ],
        'youngadults': [
            { id: 'youngadults_schedule', label: 'Meeting Schedule (Time & Location)' }
        ],
        'youth': [
            { id: 'youth_schedule', label: 'Meeting Schedule (Time & Location)' }
        ],
        'kids': [
            { id: 'kids', label: 'Upcoming Events & Info' }
        ],
/        'footer': [
            { id: 'footer_phone', label: 'Phone Number (Display)' },
            { id: 'footer_copyright', label: 'Copyright Text' },
            { id: 'footer_facebook', label: 'Facebook Link URL' },
            { id: 'footer_youtube', label: 'YouTube Link URL' }
        ]
    };

    // --- Load Data ---
    async function loadPageData(pageId) {
        editorFields.innerHTML = 'Loading...';
        const docRef = doc(db, "pages", pageId);
        const docSnap = await getDoc(docRef);
        const data = docSnap.exists() ? docSnap.data() : {};
        
        editorFields.innerHTML = '';
        const fields = pageConfig[pageId] || [];

        fields.forEach(field => {
            if (field.type === 'ticker') {
                renderTickerEditor(field, data[field.id]);
            } else if (field.type === 'cards') {
                renderCardListEditor(field, data[field.id]);
            } else {
                renderTextField(field, data[field.id]);
            }
        });
    }

    // Helper: Render Standard Text Area
    function renderTextField(field, value = '') {
        const html = `
            <div class="form-group mt-3">
                <label><strong>${field.label}</strong></label>
                <textarea class="form-control field-input" data-key="${field.id}" rows="3">${value}</textarea>
            </div>`;
        editorFields.insertAdjacentHTML('beforeend', html);
    }

    // Helper: Render Ticker List Editor
    function renderTickerEditor(field, data = []) {
        const items = Array.isArray(data) ? data : []; 
        const container = document.createElement('div');
        container.className = 'form-group mt-3 p-3 border rounded bg-light';
        container.innerHTML = `<label><strong>${field.label}</strong></label><div id="list-${field.id}"></div>`;
        
        const addButton = document.createElement('button');
        addButton.className = 'btn btn-sm btn-info mt-2';
        addButton.innerText = '+ Add Item';
        addButton.onclick = () => addTickerRow(listDiv);

        editorFields.appendChild(container);
        container.appendChild(addButton);
        
        const listDiv = container.querySelector(`#list-${field.id}`);
        items.forEach(item => addTickerRow(listDiv, item));
    }

    // UPDATED: Added Up/Down buttons for Ticker
    function addTickerRow(container, item = { text: '', link: '' }) {
        const row = document.createElement('div');
        row.className = 'ticker-row d-flex gap-2 mt-2 align-items-center';
        
        // HTML Structure
        row.innerHTML = `
            <div class="btn-group-vertical">
                <button type="button" class="btn btn-sm btn-outline-secondary btn-up" style="font-size: 0.6rem; padding: 0 4px;">▲</button>
                <button type="button" class="btn btn-sm btn-outline-secondary btn-down" style="font-size: 0.6rem; padding: 0 4px;">▼</button>
            </div>
            <input type="text" class="form-control ticker-text" placeholder="Display Text" value="${item.text}">
            <input type="text" class="form-control ticker-link" placeholder="Link URL" value="${item.link}">
            <button class="btn btn-danger btn-sm btn-remove">X</button>
        `;

        // Functionality
        row.querySelector('.btn-remove').onclick = () => row.remove();
        
        row.querySelector('.btn-up').onclick = () => {
            if (row.previousElementSibling) {
                row.parentNode.insertBefore(row, row.previousElementSibling);
            }
        };

        row.querySelector('.btn-down').onclick = () => {
            if (row.nextElementSibling) {
                // To move down, we insert the *next* element before the *current* element
                row.parentNode.insertBefore(row.nextElementSibling, row);
            }
        };

        container.appendChild(row);
    }

    // Helper: Render Card List Editor (Features & Slider)
    function renderCardListEditor(field, data = []) {
        const items = Array.isArray(data) ? data : [];
        const container = document.createElement('div');
        container.className = 'form-group mt-3 p-3 border rounded bg-light';
        container.innerHTML = `<label><strong>${field.label}</strong></label><div id="card-list-${field.id}"></div>`;
        
        const addButton = document.createElement('button');
        addButton.className = 'btn btn-sm btn-info mt-2';
        addButton.innerText = '+ Add Card/Slide';
        addButton.onclick = () => addCardRow(listDiv);

        editorFields.appendChild(container);
        container.appendChild(addButton);
        
        const listDiv = container.querySelector(`#card-list-${field.id}`);
        items.forEach(item => addCardRow(listDiv, item));
    }

    // UPDATED: Added Up/Down buttons for Cards
    function addCardRow(container, item = { title: '', text: '', image: '', link: '' }) {
        const row = document.createElement('div');
        row.className = 'card-row mt-3 p-2 border bg-white';
        
        row.innerHTML = `
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="small">Image URL</label>
                    <input type="text" class="form-control card-image" value="${item.image || ''}" placeholder="assets/images/...">
                </div>
                <div class="col-md-6">
                    <label class="small">Link URL</label>
                    <input type="text" class="form-control card-link" value="${item.link || ''}" placeholder="http://...">
                </div>
                <div class="col-md-6">
                    <label class="small">Title</label>
                    <input type="text" class="form-control card-title" value="${item.title || ''}" placeholder="Title">
                </div>
                <div class="col-md-6">
                    <label class="small">Subtitle / Description</label>
                    <textarea class="form-control card-text" rows="1" placeholder="Description">${item.text || ''}</textarea>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-2">
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-up">Move Up</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-down">Move Down</button>
                </div>
                <button class="btn btn-danger btn-sm btn-remove">Remove Card</button>
            </div>
        `;

        // Functionality
        row.querySelector('.btn-remove').onclick = () => row.remove();

        row.querySelector('.btn-up').onclick = () => {
            if (row.previousElementSibling) {
                row.parentNode.insertBefore(row, row.previousElementSibling);
            }
        };

        row.querySelector('.btn-down').onclick = () => {
            if (row.nextElementSibling) {
                row.parentNode.insertBefore(row.nextElementSibling, row);
            }
        };

        container.appendChild(row);
    }

    // Handle Page Change
    pageSelector.addEventListener('change', (e) => loadPageData(e.target.value));

    // --- Save Data ---
    document.getElementById('save-btn').addEventListener('click', async () => {
        const pageId = pageSelector.value;
        const config = pageConfig[pageId] || [];
        let updateData = {};

        config.forEach(field => {
            if (field.type === 'ticker') {
                // Logic updated to query strictly by class within specific container to ensure order is preserved
                const rows = document.querySelectorAll(`#list-${field.id} .ticker-row`);
                const items = [];
                rows.forEach(row => {
                    const text = row.querySelector('.ticker-text').value;
                    const link = row.querySelector('.ticker-link').value;
                    if(text) items.push({ text, link });
                });
                updateData[field.id] = items;
            } else if (field.type === 'cards') {
                const rows = document.querySelectorAll(`#card-list-${field.id} .card-row`);
                const items = [];
                rows.forEach(row => {
                    items.push({
                        image: row.querySelector('.card-image').value,
                        link: row.querySelector('.card-link').value,
                        title: row.querySelector('.card-title').value,
                        text: row.querySelector('.card-text').value
                    });
                });
                updateData[field.id] = items;
            } else {
                const input = document.querySelector(`.field-input[data-key="${field.id}"]`);
                if (input) updateData[field.id] = input.value;
            }
        });

        const docRef = doc(db, "pages", pageId);
        try {
            await setDoc(docRef, updateData, { merge: true });
            document.getElementById('status-msg').innerText = "Saved Successfully!";
            document.getElementById('status-msg').className = "text-success";
        } catch (err) {
            console.error(err);
            document.getElementById('status-msg').innerText = "Error: " + err.message;
            document.getElementById('status-msg').className = "text-danger";
        }
    });
</script>
</body>
</html>