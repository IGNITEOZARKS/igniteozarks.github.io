<!DOCTYPE html>
<html>
<head>
    <title>Site Admin</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <style>
        body { padding: 20px; background-color: #f4f4f4; }
        .editor-container { background: white; padding: 20px; border-radius: 8px; display: none; }
        .login-container { max-width: 400px; margin: 100px auto; background: white; padding: 30px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="login-section" class="login-container">
        <h3>Admin Login</h3>
        <input type="email" id="email" class="form-control mb-2" placeholder="Email">
        <input type="password" id="password" class="form-control mb-2" placeholder="Password">
        <button id="login-btn" class="btn btn-primary w-100">Login</button>
        <p id="login-error" class="text-danger mt-2"></p>
    </div>

    <div id="dashboard-section" class="container editor-container">
        <div class="d-flex justify-content-between">
            <h2>Website Content Editor</h2>
            <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
        </div>
        <hr>

        <label><strong>Select Page to Edit:</strong></label>
        <select id="page-selector" class="form-control mb-4">
          <option value="home">Home Page</option>
    <option value="about">About Page</option>
    <option value="contact">Contact Page</option>
    <option value="notifications">Notifications Popup</option>
            </select>

        <div id="editor-fields">
            </div>

        <button id="save-btn" class="btn btn-success mt-3">Save Changes</button>
        <p id="status-msg" class="mt-2"></p>
    </div>

   <script type="module">
    import { db, auth, doc, getDoc, setDoc, signInWithEmailAndPassword, onAuthStateChanged, signOut } from './firebase-config.js';

    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const pageSelector = document.getElementById('page-selector');
    const editorFields = document.getElementById('editor-fields');

    // --- Authentication ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loginSection.style.display = 'none';
            dashboardSection.style.display = 'block';
            loadPageData(pageSelector.value);
        } else {
            loginSection.style.display = 'block';
            dashboardSection.style.display = 'none';
        }
    });

    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            document.getElementById('login-error').innerText = "Invalid Login";
        }
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // --- Editor Configuration ---
    const pageConfig = {
        'home': [
            { id: 'hometitle', label: 'Welcome Title' },
            // UPDATED: specific type for ticker
            { id: 'home_news_ticker', label: 'News Ticker Items', type: 'ticker' } 
        ],
        'about': [
            { id: 'edit1', label: 'Section Title' },
            { id: 'edit2', label: 'Main Description' }
        ],
        'contact': [
            { id: 'contact_title', label: 'Page Title' },
            { id: 'contact_phone', label: 'Phone Number' },
            { id: 'contact_email', label: 'Email Address' }
        ],
        'notifications': [
            { id: 'notification_title', label: 'Header Title' },
            { id: 'notification_list', label: 'Notification Links', type: 'ticker' } 
        ]
        // Add events or other pages here as needed
    };

    // --- Load Data ---
    async function loadPageData(pageId) {
        editorFields.innerHTML = 'Loading...';
        const docRef = doc(db, "pages", pageId);
        const docSnap = await getDoc(docRef);
        const data = docSnap.exists() ? docSnap.data() : {};
        
        editorFields.innerHTML = '';
        const fields = pageConfig[pageId] || [];

        fields.forEach(field => {
            if (field.type === 'ticker') {
                renderTickerEditor(field, data[field.id]);
            } else {
                renderTextField(field, data[field.id]);
            }
        });
    }

    // Helper: Render Standard Text Area
    function renderTextField(field, value = '') {
        const html = `
            <div class="form-group mt-3">
                <label><strong>${field.label}</strong></label>
                <textarea class="form-control field-input" data-key="${field.id}" rows="3">${value}</textarea>
            </div>`;
        editorFields.insertAdjacentHTML('beforeend', html);
    }

    // Helper: Render Ticker List Editor
    function renderTickerEditor(field, data = []) {
        // If old data was a string (old HTML), reset it to empty array to avoid errors
        const items = Array.isArray(data) ? data : []; 

        const container = document.createElement('div');
        container.className = 'form-group mt-3 p-3 border rounded bg-light';
        container.innerHTML = `<label><strong>${field.label}</strong></label><div id="ticker-list-${field.id}"></div>`;
        
        const addButton = document.createElement('button');
        addButton.className = 'btn btn-sm btn-info mt-2';
        addButton.innerText = '+ Add Ticker Item';
        addButton.onclick = () => addTickerRow(listDiv);

        editorFields.appendChild(container);
        container.appendChild(addButton);
        
        const listDiv = container.querySelector(`#ticker-list-${field.id}`);
        // Add existing items
        items.forEach(item => addTickerRow(listDiv, item));
    }

    function addTickerRow(container, item = { text: '', link: '' }) {
        const row = document.createElement('div');
        row.className = 'ticker-row d-flex gap-2 mt-2 align-items-center';
        row.innerHTML = `
            <input type="text" class="form-control ticker-text" placeholder="Display Text" value="${item.text}">
            <input type="text" class="form-control ticker-link" placeholder="Link URL (Optional)" value="${item.link}">
            <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">X</button>
        `;
        container.appendChild(row);
    }

    // Handle Page Change
    pageSelector.addEventListener('change', (e) => loadPageData(e.target.value));

    // --- Save Data ---
    document.getElementById('save-btn').addEventListener('click', async () => {
        const pageId = pageSelector.value;
        const config = pageConfig[pageId] || [];
        let updateData = {};

        // Loop through config to gather data correctly
        config.forEach(field => {
            if (field.type === 'ticker') {
                // Gather List Data
                const rows = document.querySelectorAll(`#ticker-list-${field.id} .ticker-row`);
                const items = [];
                rows.forEach(row => {
                    const text = row.querySelector('.ticker-text').value;
                    const link = row.querySelector('.ticker-link').value;
                    if(text) items.push({ text, link });
                });
                updateData[field.id] = items;
            } else {
                // Gather Standard Data
                const input = document.querySelector(`.field-input[data-key="${field.id}"]`);
                if (input) updateData[field.id] = input.value;
            }
        });

        const docRef = doc(db, "pages", pageId);
        try {
            await setDoc(docRef, updateData, { merge: true });
            document.getElementById('status-msg').innerText = "Saved Successfully!";
            document.getElementById('status-msg').className = "text-success";
        } catch (err) {
            console.error(err);
            document.getElementById('status-msg').innerText = "Error: " + err.message;
            document.getElementById('status-msg').className = "text-danger";
        }
    });
</script>
</body>
</html>